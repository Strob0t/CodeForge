x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

services:
  docs-mcp-server:
    image: ghcr.io/arabold/docs-mcp-server:latest
    container_name: codeforge-docs-mcp
    logging: *default-logging
    ports:
      - "6280:6280"
    volumes:
      - ${HOST_PROJECT_PATH:-.}:/docs:ro
      - ${HOST_PROJECT_PATH:-.}/data/docs_mcp:/data
    environment:
      - OPENAI_API_BASE=${DOCS_MCP_API_BASE:-http://192.168.88.21:1234/v1}
      - OPENAI_API_KEY=${DOCS_MCP_API_KEY:-lmstudio}
      - DOCS_MCP_EMBEDDING_MODEL=${DOCS_MCP_EMBEDDING_MODEL:-text-embedding-qwen3-embedding-8b}
      - DOCS_MCP_TELEMETRY=false
    command: ["--protocol", "http", "--host", "0.0.0.0", "--port", "6280"]
    networks:
      - codeforge

  playwright-mcp:
    image: mcr.microsoft.com/playwright:v1.57.0-jammy
    container_name: codeforge-playwright
    logging: *default-logging
    ipc: host
    shm_size: "1gb"
    volumes:
      - ${HOST_PROJECT_PATH:-.}/data/playwright:/config
    command:
      - sh
      - -c
      - |
        npx playwright install --with-deps chromium &&
        exec npx @playwright/mcp@latest \
          --config /config/playwright-mcp.json \
          --headless \
          --no-sandbox \
          --isolated \
          --allowed-hosts '*' \
          --port 8001
    ports:
      - "8001:8001"
    networks:
      - codeforge

  postgres:
    image: postgres:17-alpine
    container_name: codeforge-postgres
    logging: *default-logging
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: codeforge
      POSTGRES_USER: codeforge
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-codeforge_dev}
    volumes:
      - pgdata:/var/lib/postgresql/data
    shm_size: 256mb
    command: >
      postgres
        -c shared_buffers=128MB
        -c effective_cache_size=384MB
        -c max_connections=100
        -c wal_level=replica
        -c archive_mode=on
        -c archive_command='test ! -f /var/lib/postgresql/data/archive/%f && cp %p /var/lib/postgresql/data/archive/%f'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U codeforge"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - codeforge

  nats:
    image: nats:2-alpine
    container_name: codeforge-nats
    logging: *default-logging
    ports:
      - "4222:4222"
      - "8222:8222"
    command: ["--jetstream", "--store_dir", "/data", "-m", "8222"]
    volumes:
      - ${HOST_PROJECT_PATH:-.}/data/nats:/data
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - codeforge

  litellm:
    image: ghcr.io/berriai/litellm:main-stable
    container_name: codeforge-litellm
    logging: *default-logging
    ports:
      - "4000:4000"
    environment:
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY:-sk-codeforge-dev}
      DATABASE_URL: postgresql://codeforge:${POSTGRES_PASSWORD:-codeforge_dev}@postgres:5432/codeforge
      OLLAMA_API_BASE: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
    volumes:
      - ${HOST_PROJECT_PATH:-.}/litellm:/app/data
    command: ["--config", "/app/config.yaml", "--port", "4000"]
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4000/health/liveliness')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - codeforge

volumes:
  pgdata:
    name: codeforge-pgdata
  nats_data:
    name: codeforge-nats-data
  litellm_data:
    name: codeforge-litellm-data
  docs_mcp_data:
    name: codeforge-docs-mcp-data

networks:
  codeforge:
    driver: bridge
    name: codeforge
